<!doctype html>
<html lang="ja">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>{{ app_name }}</title>
    <link rel="stylesheet" href="/static/styles.css" />
  </head>
  <body>
    <header class="site-header">
      <div class="site-title">{{ app_name }}</div>
      <nav class="site-nav">
        <a href="/">ホーム</a>
        <a href="/input">希望入力</a>
        <a href="/admin">勤務表作成者用</a>
        <a href="/view">完成版</a>
        <a href="/backup">バックアップ</a>
      </nav>
    </header>
    <main class="container">
      {% block content %}{% endblock %}
    </main>
    <script>
      let activeShiftLabel = null;
      let activeDay = null;
      const entryByDay = {};

      function updateEntryOutput() {
        const target = document.getElementById("request_text");
        if (!target) return;
        const monthInput = document.getElementById("month_input");
        let monthText = monthInput ? monthInput.value.trim() : "";
        let monthNum = "";
        const match = monthText.match(/(\d{1,2})\s*月/);
        if (match) {
          monthNum = match[1];
        }
        const ordered = Object.keys(entryByDay)
          .map((d) => Number(d))
          .sort((a, b) => a - b)
          .map((d) => {
            const items = Array.from(entryByDay[String(d)] || []);
            const shifts = items.join(" or ");
            const prefix = monthNum ? `${monthNum}/${d}` : `${d}`;
            return `${prefix} ${shifts}`;
          });
        target.value = ordered.join("、");
        const preview = document.getElementById("request_preview");
        if (preview) {
          preview.textContent = target.value.trim() || "（まだ入力されていません）";
        }
      }

      function appendSymbol(targetId, symbol) {
        const el = document.getElementById(targetId);
        if (!el) return;
        const start = el.selectionStart || el.value.length;
        const end = el.selectionEnd || el.value.length;
        el.value = el.value.slice(0, start) + symbol + el.value.slice(end);
        el.focus();
        el.selectionStart = el.selectionEnd = start + symbol.length;
      }

      function fillTemplate(targetId, text) {
        const el = document.getElementById(targetId);
        if (!el) return;
        if (el.value.trim().length > 0) return;
        el.value = text.trim();
        el.focus();
      }

      function setMonth(value) {
        const monthInput = document.getElementById("month_input");
        if (monthInput) {
          monthInput.value = value;
        }
        const doctorSelect = document.getElementById("doctor_select");
        const doctorValue = doctorSelect ? doctorSelect.value : "";
        const params = new URLSearchParams();
        if (value) params.set("month", value);
        if (doctorValue) params.set("doctor", doctorValue);
        if (params.toString()) {
          window.location.href = `/input?${params.toString()}`;
        }
      }

      function setActiveShift(label) {
        activeShiftLabel = label;
        document.querySelectorAll(".shift-tab").forEach((btn) => {
          btn.classList.toggle("active", btn.dataset.shift === label);
        });
        if (activeDay === null) {
          alert("日付を先に選択してください。");
          return;
        }
        appendDateWithShift(activeDay);
        unlockDateButtons();
      }

      function setActiveDay(day) {
        activeDay = day;
        document.querySelectorAll(".date-btn").forEach((btn) => {
          btn.classList.toggle("active", btn.dataset.day === String(day));
        });
        const indicator = document.getElementById("active_day_indicator");
        if (indicator) {
          indicator.textContent = day ? `選択中の日付：${day}日` : "日付未選択";
        }
        lockDateButtons(day);
      }

      function lockDateButtons(day) {
        document.querySelectorAll(".date-btn").forEach((btn) => {
          btn.disabled = btn.dataset.day !== String(day);
        });
        const indicator = document.getElementById("active_day_indicator");
        if (indicator) {
          indicator.textContent = `選択中の日付：${day}日（勤務帯を選択してください）`;
        }
      }

      function unlockDateButtons() {
        document.querySelectorAll(".date-btn").forEach((btn) => {
          btn.disabled = false;
        });
      }

      function appendDateWithShift(day) {
        const monthInput = document.getElementById("month_input");
        const target = document.getElementById("request_text");
        if (!target) return;
        let monthText = monthInput ? monthInput.value.trim() : "";
        // Extract month number from input like "2026年4月" or "4月"
        let monthNum = "";
        const match = monthText.match(/(\\d{1,2})\\s*月/);
        if (match) {
          monthNum = match[1];
        }
        const key = String(day);
        if (!entryByDay[key]) {
          entryByDay[key] = new Set();
        }
        if (entryByDay[key].has(activeShiftLabel)) {
          entryByDay[key].delete(activeShiftLabel);
          if (entryByDay[key].size === 0) {
            delete entryByDay[key];
          }
        } else {
          entryByDay[key].add(activeShiftLabel);
        }
        updateEntryOutput();
      }

      function setRequestText(value) {
        const target = document.getElementById("request_text");
        if (!target) return;
        target.value = value.trim();
        const preview = document.getElementById("request_preview");
        if (preview) {
          preview.textContent = target.value.trim() || "（まだ入力されていません）";
        }
      }

      function copyPrompt() {
        const el = document.getElementById("llm_prompt");
        if (!el) return;
        el.select();
        el.setSelectionRange(0, 99999);
        document.execCommand("copy");
        const msg = document.getElementById("copy_status");
        if (msg) {
          msg.textContent = "コピーしました";
        }
      }
    </script>
  </body>
</html>
